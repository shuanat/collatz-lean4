# Отчет: Попытка формализации single_step_potential_bounded

**Дата:** 3 октября 2025  
**Время:** 15:00 UTC  
**Задача:** Формализация аксиомы `single_step_potential_bounded` как доказанной леммы

---

## Резюме

Попытка формализации `single_step_potential_bounded` выявила **критическую проблему в определении**: текущая версия использует **ускоренный шаг** `r' = (3r+1)/2^e`, тогда как для корректности математического утверждения требуется **shortcut шаг** `T(r) = (3r+1)/2`.

**Статус:** Откат изменений, требуется экспертное решение.

---

## Экспертный анализ (от Anatoliy)

### Ключевое открытие

Эксперт указал, что аксиома `single_step_potential_bounded` **математически некорректна** для ускоренного шага:

> "If your 'single step' is the **accelerated odd step** (r'=(3r+1)/2^{ν₂(3r+1)}) (jump directly to the next odd), then the bound with '(+2β)' is **false in general**: e.g. r=41 gives ν₂(r+1)=1, r'=(3r+1)/4=31, ν₂(r'+1)=5, so the depth term jumps by (+4)."

### Корректное определение (shortcut step)

Для shortcut шага `T(r) = (3r+1)/2` экспертом доказаны **точные** свойства:

1. **Depth drops by exactly 1:** `ν₂(T(r)+1) = ν₂(r+1) - 1` (всегда!)
2. **Log bound:** `log₂(T(r)/r) ≤ 1` (не ≤ log₂(3/2), а строже!)
3. **Combined:** `ΔV ≤ 1 - β ≤ log₂(3/2) + 2β` для `β ≥ 1`

### Контрпример для ускоренного шага

- `r = 41` (нечетное), `ν₂(r+1) = ν₂(42) = 1`
- `3r+1 = 124 = 2²·31`, так что `e = 2`
- `r' = 124/4 = 31`, `ν₂(r'+1) = ν₂(32) = 5`
- **Depth jump:** `+4` (не `≤ 2`!)
- Для `β = 1`: `ΔV ≈ 3.599 > 2.585 = log₂(3/2) + 2`

---

## Что было сделано

### 1. Обновлено определение `single_step_ΔV`

**Старое (НЕВЕРНОЕ):**
```lean
noncomputable def single_step_ΔV (r : ℕ) (β : ℝ) : ℝ :=
  let r' := (3 * r + 1) / (2 ^ ((3 * r + 1).factorization 2))
  V r' β - V r β
```

**Новое (КОРРЕКТНОЕ):**
```lean
def T_shortcut (r : ℕ) : ℕ := (3 * r + 1) / 2

noncomputable def single_step_ΔV (r : ℕ) (β : ℝ) : ℝ :=
  V (T_shortcut r) β - V r β
```

### 2. Попытка формализации вспомогательных лемм

**Лемма `depth_drop_one_shortcut`:**
- Цель: доказать `depth_minus (T(r)) + 1 = depth_minus r`
- Использует разложение `r+1 = 2k` для нечетного `r`
- Проблема: множественные арифметические ошибки с вычитанием в ℕ

**Лемма `log_part_le_one`:**
- Цель: доказать `log₂(T(r)/r) ≤ 1`
- Использует оценку `T(r)/r ≤ (3r+1)/(2r) ≤ 2`
- Проблема: неправильные аргументы для `Real.log_le_log`

**Лемма `single_step_potential_bounded`:**
- Объединяет две предыдущие леммы
- Проблема: сложность работы с кастами ℕ→ℤ→ℝ для вычитаний

### 3. Множественные ошибки компиляции

Всего **16 ошибок компиляции**, включая:
- `ring` не работает с вычитанием в ℕ (6 ошибок)
- Неправильные касты типов (5 ошибок)
- Неправильные аргументы функций (3 ошибки)
- "No goals to be solved" после тактик (2 ошибки)

---

## Проблемы и уроки

### Проблема 1: Арифметика в ℕ vs ℤ vs ℝ

Lean 4 имеет **усеченное вычитание** в ℕ: `a - b = 0` если `a < b`.
Для корректной работы с `depth⁻(T(r)) = depth⁻(r) - 1` требуется:
- Либо работать в ℤ с самого начала
- Либо использовать специальные леммы для `Nat.cast_sub`

**Попытка решения:** `push_cast` + `exact_mod_cast` работает, но требует аккуратного построения доказательства.

### Проблема 2: Старый код несовместим с новым

Код из `touch_provides_onebit_bonus` использовал `r + 1 = 2 * k`,  
а новый код использует `r + 1 = k + k` (из `Even`).

Это привело к каскаду ошибок `rewrite failed: Did not find pattern k + k`.

### Проблема 3: Сложность экспертного решения

Экспертное решение предоставляет **скелет** доказательства с `sorry`,  
но требует знания специфических лемм mathlib:
- `padicValNat.mul` вместо `Nat.factorization_mul`
- Специальные леммы для деления в ℕ
- Нетривиальная работа с `Even` и `Odd`

---

## Рекомендации

### Немедленные действия

1. **Сохранить текущую версию аксиомы:**
   ```lean
   axiom single_step_potential_bounded (r : ℕ) (β : ℝ) (hr : r > 0) (hr_odd : Odd r) :
     single_step_ΔV r β ≤ log (3/2) / log 2 + β * 2
   ```

2. **Добавить примечание о shortcut vs accelerated:**
   ```lean
   /-- ⚠️ IMPORTANT: This axiom assumes the SHORTCUT step T(r) = (3r+1)/2,
       NOT the accelerated step r' = (3r+1)/2^e.
       The bound (+2β) is FALSE for the accelerated step (counterexample: r=41).
   -/
   ```

3. **Обновить `single_step_ΔV`:**
   - Уже изменено на `T_shortcut r`
   - Но оставить как axiom пока не доказано

### Долгосрочная стратегия

**Вариант A: Полная формализация (сложно)**
- Требует глубокого знания mathlib
- Необходимо разобраться с `padicValNat` API
- Оценка времени: 4-6 часов чистой работы

**Вариант B: Гибридный подход (рекомендуется)**
1. Формализовать ключевые вспомогательные леммы:
   - `depth_drop_one_shortcut` (критическая!)
   - `log_part_le_one` (относительно простая)
2. Оставить финальную комбинацию как axiom с комментарием:
   ```lean
   /-- Combines depth drop (-1) and log bound (≤1) into final bound.
       Mathematical proof: 1 - β ≤ log₂(3/2) + 2β for β ≥ 1.
       Formalization requires advanced mathlib cast lemmas.
   -/
   axiom single_step_combination ...
   ```

**Вариант C: SMT verification (быстро, но неполно)**
- Использовать Z3 для численной проверки на конечном диапазоне
- Оставить общий случай как axiom
- Добавить computational evidence

---

## Следующие шаги

### Приоритет 1: Обновить документацию

- [x] Создать этот отчет
- [ ] Обновить `EXPERT_QUESTION_2025-10-03_single_step_bound.md` с решением эксперта
- [ ] Добавить предупреждение в `SEDT.lean` о shortcut vs accelerated

### Приоритет 2: Выбрать стратегию

Дождаться решения пользователя:
- **A)** Попробовать полную формализацию (долго, но правильно)
- **B)** Гибридный подход (практично)
- **C)** SMT verification + axiom (быстро)

### Приоритет 3: Продолжить с другими аксиомами

Пока `single_step_potential_bounded` остается аксиомой, можно продолжить с:
- `plateau_touch_count_bounded` (Priority 1)
- `SEDTEpoch_head_overhead_bounded` (Priority 2)
- И т.д.

---

## Статистика

**Время работы:** ~2 часа  
**Строк кода добавлено:** 249  
**Ошибок компиляции:** 16  
**Откат:** Да (полный)  

**Извлеченные уроки:**
1. Проверять математическую корректность ПЕРЕД формализацией
2. Использовать экспертные решения как руководство, а не копипасту
3. ℕ арифметика в Lean сложнее, чем кажется
4. Формализация требует времени — не спешить!

---

## Заключение

Попытка формализации `single_step_potential_bounded` была **частично успешной**:
- ✅ Выявлена критическая математическая ошибка (accelerated vs shortcut)
- ✅ Получено экспертное решение с корректным доказательством
- ✅ Обновлено определение `single_step_ΔV` на корректное
- ❌ Не удалось завершить формализацию из-за технических сложностей

Текущая стратегия: **откат + документирование + выбор пути вперед**.

Проект остается **компилируемым** с 3 доказанными леммами:
1. `touch_provides_onebit_bonus` ✅
2. `short_epoch_potential_bounded` ✅
3. `t_log_bound_for_sedt` ✅

**Прогресс формализации SEDT:** 23% (3 из 13 аксиом заменены на леммы)

